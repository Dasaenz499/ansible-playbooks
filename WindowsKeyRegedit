- name: Cambiar valor de registro en msconfig
  hosts: windows_hosts
  gather_facts: false
  become: true

  vars:
    reg_path: "HKLM\\SOFTWARE\\Microsoft\\Shared Tools\\MSConfig"
    reg_value_name: "limit"
    new_value: "0"

  tasks:
    - name: Guardar valor original de la llave de registro en una variable
      win_shell: |
        $regValue = Get-ItemProperty -Path 'Registry::{{ reg_path }}' -Name '{{ reg_value_name }}'
        $originalValue = $regValue.{{ reg_value_name }}
        Write-Host "Valor original: $originalValue"
      register: reg_value_output

    - name: Cambiar valor de la llave de registro
      win_shell: |
        Set-ItemProperty -Path 'Registry::{{ reg_path }}' -Name '{{ reg_value_name }}' -Value '{{ new_value }}' -Force
        Write-Host "Valor cambiado a: {{ new_value }}"

    - name: Verificar cambio en la llave de registro
      win_shell: |
        $regValue = Get-ItemProperty -Path 'Registry::{{ reg_path }}' -Name '{{ reg_value_name }}'
        $changedValue = $regValue.{{ reg_value_name }}
        if ($changedValue -eq '{{ new_value }}') {
          Write-Host "Cambio exitoso"
        } else {
          Write-Host "No se pudo realizar el cambio"
        }
      register: reg_value_output
